<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<title>My chatüí≠ JAW</title>

<style>
* { box-sizing: border-box; }
html, body { touch-action: manipulation; } /* Prevent zoom on double tap */

body {
  font-family: Arial, sans-serif;
  margin: 0;
  padding: 0;
  background: #e5e5e5;
  display: flex;
  flex-direction: column;
  height: 100vh;
  overflow: hidden;
}

header {
  background: linear-gradient(90deg, #4a90e2, #6aa8ff);
  color: #fff;
  text-align: center;
  padding: 15px;
  font-size: 1.8rem;
  position: fixed;
  top: 0;
  width: 100%;
  z-index: 10;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

.real-time-clock, .online-users {
  position: fixed;
  top: 15px;
  padding: 5px 10px;
  font-size: 1rem;
  color: white;
  background-color: rgba(0,0,0,0.3);
  border-radius: 10px;
  z-index: 20;
}
.real-time-clock { left: 15px; }
.online-users { right: 15px; }

.chat-area {
  flex: 1;
  margin-top: 60px;
  margin-bottom: 80px;
  padding: 10px;
  overflow-y: auto;
  background: #f2f2f2;
  display: flex;
  flex-direction: column-reverse;
}

#wishlistList {
  list-style: none;
  padding: 0;
  margin: 0;
  display: flex;
  flex-direction: column-reverse;
  gap: 10px;
}

.bubble {
  background: white;
  padding: 12px 15px;
  border-radius: 20px;
  max-width: 80%;
  position: relative;
  animation: slideIn 0.3s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  gap: 5px;
}

.bubble img { max-width: 150px; border-radius: 15px; margin-top: 5px; }
video { max-width: 200px; border-radius: 15px; margin-top: 5px; }

@keyframes slideIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.input-container {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  padding: 8px 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: 0 -2px 4px rgba(0,0,0,0.15);
}

.input-container input[type="text"] {
  flex: 1;
  padding: 12px;
  font-size: 1rem;
  border-radius: 20px;
  border: 1px solid #ccc;
}

.input-container button {
  background: #4a90e2;
  color: white;
  padding: 12px 18px;
  border: none;
  font-size: 1rem;
  border-radius: 20px;
  cursor: pointer;
  flex-shrink: 0;
}

.input-container input[type="file"] { display: none; }

.file-label {
  font-size: 22px;
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  background: #f2f2f2;
  flex-shrink: 0;
  user-select: none;
}

#typingIndicator {
  font-size: 0.9rem;
  color: #777;
  padding-left: 10px;
  margin-bottom: 5px;
  display: none;
}

/* ==========================
   üîê PIN SYSTEM
========================== */
#lockScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: linear-gradient(180deg, #4a90e2, #ffffff);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  gap: 20px;
}

#pinBoxes {
  display: flex;
  gap: 10px;
}

.pinBox {
  width: 45px;
  height: 55px;
  text-align: center;
  font-size: 1.8rem;
  border-radius: 10px;
  border: 2px solid #ffffff;
  background: rgba(255,255,255,0.8);
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

#pinPad {
  display: grid;
  grid-template-columns: repeat(3, 70px);
  gap: 12px;
  margin-top: 10px;
}

.pinBtn {
  width: 70px;
  height: 70px;
  font-size: 1.6rem;
  border: none;
  border-radius: 15px;
  background: #ffffff;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  cursor: pointer;
}

.shake { animation: shakeAnim 0.3s; }

@keyframes shakeAnim {
  0% { transform: translateX(0); }
  25% { transform: translateX(-6px); }
  50% { transform: translateX(6px); }
  75% { transform: translateX(-6px); }
  100% { transform: translateX(0); }
}

/* ==========================
   üîÑ REFRESH BUTTON
========================== */
#refreshBtn {
  position: fixed;
  top: 70px;
  right: 20px;
  padding: 10px 15px;
  background: linear-gradient(90deg, #4a90e2, #6aa8ff);
  color: white;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  z-index: 50;
  font-size: 1.1rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transition: 0.3s;
}
#refreshBtn:hover { transform: scale(1.05); box-shadow: 0 4px 8px rgba(0,0,0,0.4); }

/* ==========================
   üí¨ WELCOME ANIMATION
========================== */
#welcomeMsg {
  position: fixed;
  top: 40%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2rem;
  font-weight: bold;
  color: #fff;
  text-shadow: 0 2px 6px rgba(0,0,0,0.5);
  opacity: 0;
  z-index: 99999;
  pointer-events: none;
  white-space: nowrap;
}
@keyframes welcomeAnim {
  0% { transform: translate(-200%, -50%); opacity: 0; }
  50% { transform: translate(0%, -50%); opacity: 1; }
  100% { transform: translate(200%, -50%); opacity: 0; }
}
</style>
</head>

<body>

<!-- üîê LOCK SCREEN -->
<div id="lockScreen">
  <h2 style="color:white; text-shadow:0 2px 4px rgba(0,0,0,0.3);">Enter PIN to Access Chat</h2>

  <div id="pinBoxes">
    <input class="pinBox" disabled>
    <input class="pinBox" disabled>
    <input class="pinBox" disabled>
    <input class="pinBox" disabled>
    <input class="pinBox" disabled>
  </div>

  <div id="pinPad">
    <button class="pinBtn">1</button>
    <button class="pinBtn">2</button>
    <button class="pinBtn">3</button>
    <button class="pinBtn">4</button>
    <button class="pinBtn">5</button>
    <button class="pinBtn">6</button>
    <button class="pinBtn">7</button>
    <button class="pinBtn">8</button>
    <button class="pinBtn">9</button>
    <button class="pinBtn" id="welBoss">üëë</button>
    <button class="pinBtn">0</button>
    <button class="pinBtn" id="pinDelete">‚å´</button>
    <div></div>
  </div>
</div>

<div id="welcomeMsg">Welcome Boss John!</div>

<div class="real-time-clock" id="realTimeClock"></div>
<div class="online-users" id="onlineUsers">Online: 0</div>

<header>john secret chatüí≠</header>
<div id="typingIndicator">‚óè Someone is typing...</div>

<button id="refreshBtn">üîÑ Refresh</button>

<div class="chat-area" id="wishlist">
  <ul id="wishlistList"></ul>
</div>

<div class="input-container">
  <label class="file-label">üìé<input type="file" id="fileInput"></label>
  <input type="text" id="item" placeholder="Type your message...">
  <button id="addButton">Send</button>
</div>

<script>
/* ==========================
   üîê PIN SYSTEM
========================== */
const CORRECT_PIN = "10110";
let typedPIN = "";
const pinBoxes = document.querySelectorAll(".pinBox");
const lockScreen = document.getElementById("lockScreen");

document.querySelectorAll(".pinBtn").forEach(btn => {
  btn.onclick = () => {
    const val = btn.textContent;
    if(val === "0" || /\d/.test(val)) {
      if (typedPIN.length < 5) {
        typedPIN += val;
        pinBoxes[typedPIN.length-1].value = "‚Ä¢";
      }
      if (typedPIN.length===5) {
        if (typedPIN === CORRECT_PIN) lockScreen.style.display="none";
        else {
          pinBoxes.forEach(b => b.classList.add("shake"));
          setTimeout(()=>{ pinBoxes.forEach(b=>{b.value=""; b.classList.remove("shake");}); typedPIN=""; },300);
        }
      }
    }
  };
});

document.getElementById("pinDelete").onclick = () => {
  if (typedPIN.length>0) {
    typedPIN = typedPIN.slice(0,-1);
    pinBoxes[typedPIN.length].value="";
  }
};

/* ==========================
   üí¨ WELCOME BOSS
========================== */
document.getElementById("welBoss").onclick = () => {
  const msg = document.getElementById("welcomeMsg");
  msg.style.animation = "none";
  void msg.offsetWidth; // restart animation
  msg.style.animation = "2s ease forwards welcomeAnim";
};

/* ==========================
   CHAT SCRIPT
========================== */
const CLOUD_NAME = "drokorpop";
const UPLOAD_PRESET = "secret_chat_upload";

function formatDate(d){ return new Date(d).toLocaleString(); }

function createBubble(item){
  const li=document.createElement("li");
  const bubble=document.createElement("div");
  bubble.className="bubble them";
  let content=`<div>${item.name||""}</div>`;
  if(item.imageUrl){ content+=`<img src="${item.imageUrl}"><a href="${item.imageUrl}" download style="color:#4a90e2;">‚¨áÔ∏è Download Image</a>`; }
  if(item.videoUrl){ content+=`<video controls><source src="${item.videoUrl}"></video><a href="${item.videoUrl}" download style="color:#4a90e2;">‚¨áÔ∏è Download Video</a>`; }
  if(item.fileUrl){ content+=`<a href="${item.fileUrl}" target="_blank" style="color:#4a90e2;">üìÑ Open File</a><a href="${item.fileUrl}" download style="color:#4a90e2;">‚¨áÔ∏è Download File</a>`; }
  content+=`<small style="font-size:0.7rem;color:#666;">${formatDate(item.createdAt)}</small>
    <div style="text-align:right;">
      <button onclick="copyText('${item.name?.replace(/'/g,"&#39;")||""}')">üìã</button>
      <button onclick="deleteItem('${item._id}')">‚ùå</button>
    </div>`;
  bubble.innerHTML=content;
  li.appendChild(bubble);
  return li;
}

function noScrollDown(){ document.querySelector(".chat-area").scrollTo({ top:0, behavior:'smooth'}); }

async function fetchWishlist(){
  try{
    const res = await fetch('/wishlist');
    const data = await res.json();
    const list = document.getElementById('wishlistList');
    list.innerHTML='';
    data.forEach(msg=>list.appendChild(createBubble(msg)));
    noScrollDown();
  } catch(e){ console.error(e); }
}

async function uploadFile(file){
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", UPLOAD_PRESET);
  const uploadUrl=`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/upload`;
  const res = await fetch(uploadUrl, { method:"POST", body:formData });
  const data = await res.json();
  return data.secure_url;
}

async function addItem(){
  const input=document.getElementById('item');
  const fileInput=document.getElementById('fileInput');
  const text=input.value.trim();
  let imageUrl=null, videoUrl=null, fileUrl=null;
  if(fileInput.files.length>0){
    const file=fileInput.files[0];
    const url=await uploadFile(file);
    if(file.type.startsWith("image")) imageUrl=url;
    else if(file.type.startsWith("video")) videoUrl=url;
    else fileUrl=url;
  }
  if(!text && !imageUrl && !videoUrl && !fileUrl) return;
  await fetch('/wishlist',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:text,imageUrl,videoUrl,fileUrl,createdAt:new Date().toISOString()})});
  input.value=''; fileInput.value="";
  fetchWishlist();
}

async function deleteItem(id){ await fetch(`/wishlist/${id}`,{method:'DELETE'}); fetchWishlist(); }

function copyText(t){ navigator.clipboard.writeText(t); }

setInterval(()=>{ document.getElementById('realTimeClock').textContent=new Date().toLocaleTimeString(); },1000);

setInterval(async()=>{ try{ const r=await fetch('/online-users'); const d=await r.json(); document.getElementById('onlineUsers').textContent=`Online: ${d.count}`; }catch(e){} },3000);

['click','keydown','mousemove'].forEach(e=>{ document.addEventListener(e,()=>{ fetch('/heartbeat',{method:'POST'}); }); });

let typingTimeout;
document.getElementById('item').addEventListener('input',()=>{
  document.getElementById('typingIndicator').style.display='block';
  clearTimeout(typingTimeout);
  typingTimeout=setTimeout(()=>{ document.getElementById('typingIndicator').style.display='none'; },1000);
});

fetchWishlist();
document.getElementById('addButton').onclick=addItem;
document.getElementById('item').onkeydown=(e)=>{ if(e.key==='Enter') addItem(); };

document.getElementById('refreshBtn').onclick = async () => {
  const btn=document.getElementById('refreshBtn'); btn.disabled=true; await fetchWishlist(); btn.disabled=false;
};
</script>
</body>
</html>
